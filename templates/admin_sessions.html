{% extends 'base.html' %}
{% block title %}Session Management - Admin Dashboard{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-desktop me-2"></i>Session Management</h2>
    <div>
        <button class="btn btn-outline-warning" onclick="cleanupOldSessions()">
            <i class="fas fa-broom me-1"></i>Cleanup Old Sessions
        </button>
        <a href="/admin" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>Back to Admin
        </a>
    </div>
</div>

<!-- Alert Panel for Multiple Sessions -->
{% if multiple_sessions %}
<div class="alert alert-warning">
    <h5><i class="fas fa-exclamation-triangle me-2"></i>Users with Multiple Active Sessions</h5>
    <div class="row">
        {% for item in multiple_sessions %}
        <div class="col-md-6 mb-3">
            <div class="card border-warning">
                <div class="card-header">
                    <strong>{{ item.user.username }}</strong>
                    {% if item.different_ips %}
                        <span class="badge bg-danger ms-2">Different IPs</span>
                    {% endif %}
                    <span class="badge bg-warning ms-1">{{ item.sessions|length }} Sessions</span>
                </div>
                <div class="card-body p-2">
                    {% for session in item.sessions %}
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                        <div>
                            <small><strong>{{ session.ip_address }}</strong></small><br>
                            <small class="text-muted">{{ session.browser }} on {{ session.operating_system }}</small>
                            {% if session.location_city %}
                            <br><small class="text-info">{{ session.location_city }}, {{ session.location_country }}</small>
                            {% endif %}
                        </div>
                        <div class="text-end">
                            <small class="text-muted">{{ session.last_activity.strftime('%m-%d %H:%M') }}</small><br>
                            <button class="btn btn-sm btn-outline-danger" onclick="terminateSession('{{ session.id }}')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Active Sessions Table -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-users me-2"></i>All Active Sessions ({{ active_sessions|length }})</h5>
        <button class="btn btn-sm btn-outline-primary" onclick="refreshSessions()">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="sessions-table">
                <thead class="table-light">
                    <tr>
                        <th>User</th>
                        <th>IP Address</th>
                        <th>Location</th>
                        <th>Device Info</th>
                        <th>Browser</th>
                        <th>Login Time</th>
                        <th>Last Activity</th>
                        <th>Duration</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for session, user in active_sessions %}
                    <tr id="session-{{ session.id }}">
                        <td>
                            <div class="d-flex align-items-center">
                                <div>
                                    <strong>{{ user.username }}</strong>
                                    {% if user.is_admin %}
                                        <span class="badge bg-danger ms-1">Admin</span>
                                    {% endif %}
                                    <br>
                                    <small class="text-muted">{{ user.email }}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="font-monospace">{{ session.ip_address }}</span>
                            {% if user.get_concurrent_sessions_from_different_ips()[0] %}
                                <br><span class="badge bg-warning">Multi-IP</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if session.location_city %}
                                <i class="fas fa-map-marker-alt text-info"></i>
                                {{ session.location_city }}, {{ session.location_country }}
                            {% else %}
                                <span class="text-muted">Unknown</span>
                            {% endif %}
                        </td>
                        <td>
                            <div>
                                <i class="fas fa-{{ 'mobile-alt' if 'Mobile' in session.device else 'desktop' }}"></i>
                                {{ session.device }}
                            </div>
                            <small class="text-muted">{{ session.operating_system }}</small>
                        </td>
                        <td>
                            <div title="{{ session.user_agent }}">
                                {{ session.browser }}
                            </div>
                        </td>
                        <td class="text-muted small">
                            {{ session.login_time.strftime('%Y-%m-%d %H:%M') }}
                        </td>
                        <td class="text-muted small">
                            <span title="{{ session.last_activity.strftime('%Y-%m-%d %H:%M:%S') }}">
                                {{ session.last_activity.strftime('%H:%M') }}
                            </span>
                            {% set minutes_ago = ((current_time - session.last_activity).total_seconds() / 60) | int %}
                            {% if minutes_ago < 5 %}
                                <span class="badge bg-success">Active</span>
                            {% elif minutes_ago < 30 %}
                                <span class="badge bg-warning">{{ minutes_ago }}m ago</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ minutes_ago }}m ago</span>
                            {% endif %}
                        </td>
                        <td class="text-muted small">
                            {% set duration_hours = ((session.last_activity - session.login_time).total_seconds() / 3600) | int %}
                            {% set duration_minutes = (((session.last_activity - session.login_time).total_seconds() % 3600) / 60) | int %}
                            {% if duration_hours > 0 %}
                                {{ duration_hours }}h {{ duration_minutes }}m
                            {% else %}
                                {{ duration_minutes }}m
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-info" onclick="viewSessionDetails('{{ session.id }}')" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline-primary" onclick="viewUserSessions({{ user.id }})" title="User's All Sessions">
                                    <i class="fas fa-history"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="terminateSession('{{ session.id }}')" title="Terminate Session">
                                    <i class="fas fa-sign-out-alt"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Session Statistics -->
<div class="row mt-4">
    <div class="col-md-4">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h4>{{ active_sessions|length }}</h4>
                <small>Active Sessions</small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <h4>{{ multiple_sessions|length }}</h4>
                <small>Users with Multiple Sessions</small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-danger text-white">
            <div class="card-body text-center">
                <h4>{{ multiple_sessions|selectattr('different_ips')|list|length }}</h4>
                <small>Suspicious Multi-IP Users</small>
            </div>
        </div>
    </div>
</div>

<!-- Session Details Modal -->
<div class="modal fade" id="sessionDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Session Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="sessionDetailsContent">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>
</div>

<!-- User Sessions History Modal -->
<div class="modal fade" id="userSessionsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">User Session History</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="userSessionsContent">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>
</div>

<style>
/* Enhanced styling for session management */
.card {
    background-color: #1e1e1e !important;
    border-color: #333 !important;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.3);
}

.card-header {
    background-color: #2a2a2a !important;
    border-bottom-color: #444 !important;
    color: #e0e0e0 !important;
}

.table {
    color: #e0e0e0 !important;
}

.table-light {
    background-color: #2a2a2a !important;
    color: #e0e0e0 !important;
}

.table th {
    border-bottom-color: #444 !important;
    font-weight: 600;
}

.table td {
    border-bottom-color: #444 !important;
}

.bg-light {
    background-color: #2a2a2a !important;
}

.text-muted {
    color: #6c757d !important;
}

.alert-warning {
    background-color: #664d03 !important;
    border-color: #997404 !important;
    color: #ffda6a !important;
}

.border-warning {
    border-color: #997404 !important;
}

.font-monospace {
    font-family: 'Courier New', monospace;
}

.badge {
    font-size: 0.75em;
}

@keyframes pulse-warning {
    0% { background-color: #ffc107; }
    50% { background-color: #ffed4e; }
    100% { background-color: #ffc107; }
}

.badge.bg-warning {
    animation: pulse-warning 2s infinite;
}

.table-responsive {
    max-height: 600px;
    overflow-y: auto;
}

.modal-content {
    background-color: #1e1e1e !important;
    border-color: #333 !important;
}

.modal-header {
    border-bottom-color: #444 !important;
}
</style>

<script>
function terminateSession(sessionId) {
    if (confirm('Are you sure you want to terminate this session? The user will be logged out immediately.')) {
        fetch(`/admin/session/${sessionId}/terminate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', data.message);
                document.getElementById(`session-${sessionId}`).remove();
                updateSessionCounts();
            } else {
                showAlert('danger', data.error);
            }
        })
        .catch(error => {
            showAlert('danger', 'An error occurred');
            console.error(error);
        });
    }
}

function viewSessionDetails(sessionId) {
    // Find session data from the table
    const row = document.getElementById(`session-${sessionId}`);
    if (!row) return;
    
    const cells = row.cells;
    const content = `
        <div class="row">
            <div class="col-12">
                <h6>Session Information</h6>
                <table class="table table-sm">
                    <tr><td><strong>Session ID:</strong></td><td class="font-monospace">${sessionId}</td></tr>
                    <tr><td><strong>User:</strong></td><td>${cells[0].textContent.trim()}</td></tr>
                    <tr><td><strong>IP Address:</strong></td><td class="font-monospace">${cells[1].textContent.trim()}</td></tr>
                    <tr><td><strong>Location:</strong></td><td>${cells[2].textContent.trim()}</td></tr>
                    <tr><td><strong>Device:</strong></td><td>${cells[3].textContent.trim()}</td></tr>
                    <tr><td><strong>Browser:</strong></td><td>${cells[4].textContent.trim()}</td></tr>
                    <tr><td><strong>Login Time:</strong></td><td>${cells[5].textContent.trim()}</td></tr>
                    <tr><td><strong>Last Activity:</strong></td><td>${cells[6].textContent.trim()}</td></tr>
                    <tr><td><strong>Session Duration:</strong></td><td>${cells[7].textContent.trim()}</td></tr>
                </table>
                
                <div class="mt-3">
                    <h6>Actions</h6>
                    <button class="btn btn-danger" onclick="terminateSession('${sessionId}'); $('#sessionDetailsModal').modal('hide');">
                        <i class="fas fa-sign-out-alt me-1"></i>Terminate Session
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('sessionDetailsContent').innerHTML = content;
    new bootstrap.Modal(document.getElementById('sessionDetailsModal')).show();
}

function viewUserSessions(userId) {
    fetch(`/admin/user/${userId}/sessions`)
        .then(response => response.json())
        .then(data => {
            if (data.sessions) {
                const content = `
                    <div class="row mb-3">
                        <div class="col-12">
                            <h6>User: ${data.user.username} (${data.user.email})</h6>
                            ${data.has_multiple_active ? '<span class="badge bg-warning">Has Multiple Active Sessions</span>' : ''}
                        </div>
                    </div>
                    
                    <div class="table-responsive" style="max-height: 500px;">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>IP Address</th>
                                    <th>Device & Browser</th>
                                    <th>Location</th>
                                    <th>Login Time</th>
                                    <th>Last Activity</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.sessions.map(session => `
                                    <tr class="${session.is_active ? 'table-success' : 'table-secondary'}">
                                        <td class="font-monospace">${session.ip_address}</td>
                                        <td>
                                            <div>${session.device}</div>
                                            <small class="text-muted">${session.browser} on ${session.operating_system}</small>
                                        </td>
                                        <td>${session.location || 'Unknown'}</td>
                                        <td class="small">${session.login_time}</td>
                                        <td class="small">${session.last_activity}</td>
                                        <td>
                                            <span class="badge ${session.is_active ? 'bg-success' : 'bg-secondary'}">
                                                ${session.is_active ? 'Active' : 'Inactive'}
                                            </span>
                                        </td>
                                        <td>
                                            ${session.is_active ? 
                                                `<button class="btn btn-sm btn-outline-danger" onclick="terminateSession('${session.id}')">
                                                    <i class="fas fa-times"></i>
                                                </button>` : 
                                                '<span class="text-muted">-</span>'
                                            }
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                document.getElementById('userSessionsContent').innerHTML = content;
                new bootstrap.Modal(document.getElementById('userSessionsModal')).show();
            }
        })
        .catch(error => {
            showAlert('danger', 'Failed to load user sessions');
            console.error(error);
        });
}

function cleanupOldSessions() {
    if (confirm('This will remove all inactive sessions older than 30 days. Continue?')) {
        fetch('/admin/cleanup_sessions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', `Cleaned up ${data.removed} old sessions`);
            } else {
                showAlert('danger', data.error);
            }
        })
        .catch(error => {
            showAlert('danger', 'An error occurred during cleanup');
            console.error(error);
        });
    }
}

function refreshSessions() {
    showAlert('info', 'Refreshing sessions...');
    setTimeout(() => {
        location.reload();
    }, 1000);
}

function updateSessionCounts() {
    // Update the statistics cards
    const activeSessionsCount = document.querySelectorAll('#sessions-table tbody tr').length;
    // Update counts in the UI if needed
}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.container');
    container.insertBefore(alertDiv, container.firstChild);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Auto-refresh every 2 minutes
setInterval(() => {
    location.reload();
}, 120000);

// Initialize tooltips
document.addEventListener('DOMContentLoaded', function() {
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
    const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>

{% endblock %}