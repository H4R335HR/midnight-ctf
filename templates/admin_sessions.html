{% extends 'base.html' %}
{% block title %}Session Management - Admin Dashboard{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-desktop me-2"></i>Session Management</h2>
    <div>
        <button class="btn btn-outline-warning" onclick="cleanupOldSessions()">
            <i class="fas fa-broom me-1"></i>Cleanup Old Sessions
        </button>
        <a href="/admin" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>Back to Admin
        </a>
    </div>
</div>

<!-- New Section: Recent Users with Sessions -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-users me-2"></i>All Users with Recent Sessions</h5>
        <button class="btn btn-sm btn-outline-primary" onclick="loadRecentUsers()">
            <i class="fas fa-sync-alt"></i> Load Recent Users
        </button>
    </div>
    <div class="card-body" id="recent-users-section">
        <p class="text-muted text-center">Click "Load Recent Users" to see all users who have had sessions in the last 30 days</p>
    </div>
</div>

<!-- Alert Panel for Multiple Sessions -->
{% if multiple_sessions %}
<div class="alert alert-warning">
    <h5><i class="fas fa-exclamation-triangle me-2"></i>Users with Multiple Active Sessions</h5>
    <div class="row">
        {% for item in multiple_sessions %}
        <div class="col-md-6 mb-3">
            <div class="card border-warning">
                <div class="card-header">
                    <strong>{{ item.user.username }}</strong>
                    {% if item.different_ips %}
                        <span class="badge bg-danger ms-2">Different IPs</span>
                    {% endif %}
                    <span class="badge bg-warning ms-1">{{ item.sessions|length }} Sessions</span>
                </div>
                <div class="card-body p-2">
                    {% for session in item.sessions %}
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                        <div>
                            <small><strong>{{ session.ip_address }}</strong></small><br>
                            <small class="text-muted">{{ session.browser }} on {{ session.operating_system }}</small>
                            {% if session.location_city %}
                            <br><small class="text-info">{{ session.location_city }}, {{ session.location_country }}</small>
                            {% endif %}
                        </div>
                        <div class="text-end">
                            <small class="text-muted" data-utc-time="{{ session.last_activity.isoformat() }}">Loading...</small>
                            <br><small class="text-info">IST</small><br>
                            <button class="btn btn-sm btn-outline-danger" onclick="terminateSession('{{ session.id }}')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Active Sessions Table -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-users me-2"></i>All Active Sessions ({{ active_sessions|length }})</h5>
        <button class="btn btn-sm btn-outline-primary" onclick="refreshSessions()">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="sessions-table">
                <thead class="table-light">
                    <tr>
                        <th>User</th>
                        <th>IP Address</th>
                        <th>Location</th>
                        <th>Device Info</th>
                        <th>Browser</th>
                        <th>Login Time</th>
                        <th>Last Activity</th>
                        <th>Duration</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for session, user in active_sessions %}
                    <tr id="session-{{ session.id }}">
                        <td>
                            <div class="d-flex align-items-center">
                                <div>
                                    <strong>{{ user.username }}</strong>
                                    {% if user.is_admin %}
                                        <span class="badge bg-danger ms-1">Admin</span>
                                    {% endif %}
                                    <br>
                                    <small class="text-muted">{{ user.email }}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="font-monospace">{{ session.ip_address }}</span>
                            {% if user.get_concurrent_sessions_from_different_ips()[0] %}
                                <br><span class="badge bg-warning">Multi-IP</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if session.location_city %}
                                <i class="fas fa-map-marker-alt text-info"></i>
                                {{ session.location_city }}, {{ session.location_country }}
                            {% else %}
                                <span class="text-muted">Unknown</span>
                            {% endif %}
                        </td>
                        <td>
                            <div>
                                <i class="fas fa-{{ 'mobile-alt' if 'Mobile' in session.device else 'desktop' }}"></i>
                                {{ session.device }}
                            </div>
                            <small class="text-muted">{{ session.operating_system }}</small>
                        </td>
                        <td>
                            <div title="{{ session.user_agent }}">
                                {{ session.browser }}
                            </div>
                        </td>
                        <td class="text-muted small" data-login-time="{{ session.login_time.isoformat() }}">
                            Loading...
                        </td>
                        <td class="text-muted small" data-last-activity="{{ session.last_activity.isoformat() }}">
                            Loading...
                        </td>
                        <td class="text-muted small" 
                            data-duration 
                            data-login="{{ session.login_time.isoformat() }}" 
                            data-last="{{ session.last_activity.isoformat() }}">
                            Loading...
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-info" onclick="viewSessionDetails('{{ session.id }}')" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline-primary" onclick="viewUserSessions({{ user.id }})" title="User's All Sessions">
                                    <i class="fas fa-history"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="terminateSession('{{ session.id }}')" title="Terminate Session">
                                    <i class="fas fa-sign-out-alt"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Session Statistics -->
<div class="row mt-4">
    <div class="col-md-4">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h4>{{ active_sessions|length }}</h4>
                <small>Active Sessions</small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <h4>{{ multiple_sessions|length }}</h4>
                <small>Users with Multiple Sessions</small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-danger text-white">
            <div class="card-body text-center">
                <h4>{{ multiple_sessions|selectattr('different_ips')|list|length }}</h4>
                <small>Suspicious Multi-IP Users</small>
            </div>
        </div>
    </div>
</div>

<!-- Session Details Modal -->
<div class="modal fade" id="sessionDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Session Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="sessionDetailsContent">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>
</div>

<!-- User Sessions History Modal -->
<div class="modal fade" id="userSessionsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">User Session History</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="userSessionsContent">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>
</div>

<style>
/* Enhanced styling for session management */
.card {
    background-color: #1e1e1e !important;
    border-color: #333 !important;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.3);
}

.card-header {
    background-color: #2a2a2a !important;
    border-bottom-color: #444 !important;
    color: #e0e0e0 !important;
}

.table {
    color: #e0e0e0 !important;
}

.table-light {
    background-color: #2a2a2a !important;
    color: #e0e0e0 !important;
}

.table th {
    border-bottom-color: #444 !important;
    font-weight: 600;
}

.table td {
    border-bottom-color: #444 !important;
}

.bg-light {
    background-color: #2a2a2a !important;
}

.text-muted {
    color: #6c757d !important;
}

.alert-warning {
    background-color: #664d03 !important;
    border-color: #997404 !important;
    color: #ffda6a !important;
}

.border-warning {
    border-color: #997404 !important;
}

.font-monospace {
    font-family: 'Courier New', monospace;
}

.badge {
    font-size: 0.75em;
}

@keyframes pulse-warning {
    0% { background-color: #ffc107; }
    50% { background-color: #ffed4e; }
    100% { background-color: #ffc107; }
}

.badge.bg-warning {
    animation: pulse-warning 2s infinite;
}

.table-responsive {
    max-height: 600px;
    overflow-y: auto;
}

.modal-content {
    background-color: #1e1e1e !important;
    border-color: #333 !important;
}

.modal-header {
    border-bottom-color: #444 !important;
}

.user-card {
    transition: all 0.2s ease-in-out;
    cursor: pointer;
}

.user-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
}

.user-status-active {
    border-left: 4px solid #28a745;
}

.user-status-inactive {
    border-left: 4px solid #6c757d;
}
</style>

<script>
// Timezone conversion functions
function formatToIST(utcDateString) {
    if (!utcDateString) return 'N/A';
    
    // Ensure the date is treated as UTC by adding 'Z' if not present
    const utcString = utcDateString.includes('Z') ? utcDateString : utcDateString + 'Z';
    const utcDate = new Date(utcString);
    const istOptions = {
        timeZone: 'Asia/Kolkata',
        month: 'short',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
    };
    
    return utcDate.toLocaleString('en-IN', istOptions);
}

function formatTimeOnly(utcDateString) {
    if (!utcDateString) return 'N/A';
    
    // Ensure the date is treated as UTC by adding 'Z' if not present
    const utcString = utcDateString.includes('Z') ? utcDateString : utcDateString + 'Z';
    const utcDate = new Date(utcString);
    const istOptions = {
        timeZone: 'Asia/Kolkata',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
    };
    
    return utcDate.toLocaleString('en-IN', istOptions);
}

function getTimeAgo(utcDateString) {
    if (!utcDateString) return '';
    
    // Ensure the date is treated as UTC by adding 'Z' if not present
    const utcString = utcDateString.includes('Z') ? utcDateString : utcDateString + 'Z';
    const utcDate = new Date(utcString);
    const now = new Date();
    const diffMs = now - utcDate;
    const diffMins = Math.floor(diffMs / (1000 * 60));
    
    if (diffMins < 5) return '<span class="badge bg-success">Active now</span>';
    if (diffMins < 60) return `<span class="badge bg-warning">${diffMins}m ago</span>`;
    if (diffMins < 1440) return `<span class="badge bg-secondary">${Math.floor(diffMins/60)}h ago</span>`;
    return `<span class="badge bg-secondary">${Math.floor(diffMins/1440)}d ago</span>`;
}

function calculateDuration(loginTime, lastActivity) {
    if (!loginTime || !lastActivity) return 'N/A';
    
    // Ensure the dates are treated as UTC by adding 'Z' if not present
    const loginString = loginTime.includes('Z') ? loginTime : loginTime + 'Z';
    const lastActivityString = lastActivity.includes('Z') ? lastActivity : lastActivity + 'Z';
    
    const start = new Date(loginString);
    const end = new Date(lastActivityString);
    const diffMs = end - start;
    const diffMins = Math.floor(diffMs / (1000 * 60));
    const hours = Math.floor(diffMins / 60);
    const minutes = diffMins % 60;
    
    if (hours > 0) return `${hours}h ${minutes}m`;
    return `${minutes}m`;
}

function formatLastActivity(utcDateString) {
    if (!utcDateString) return 'N/A';
    
    const utcDate = new Date(utcDateString);
    const istDate = new Date(utcDate.toLocaleString("en-US", {timeZone: "Asia/Kolkata"}));
    const timeStr = formatTimeOnly(utcDateString);
    const fullTimeStr = formatToIST(utcDateString);
    
    return `Last activity: ${timeStr} IST`;
}

// Convert all timestamps on page load
document.addEventListener('DOMContentLoaded', function() {
    convertTimestampsToIST();
    
    // Update time ago badges every minute
    setInterval(updateTimeAgoBadges, 60000);
});

function convertTimestampsToIST() {
    // Convert login times
    document.querySelectorAll('[data-login-time]').forEach(element => {
        const utcTime = element.getAttribute('data-login-time');
        const istTime = formatToIST(utcTime);
        element.innerHTML = istTime + '<br><small class="text-info">IST</small>';
    });
    
    // Convert last activity times
    document.querySelectorAll('[data-last-activity]').forEach(element => {
        const utcTime = element.getAttribute('data-last-activity');
        const timeOnly = formatTimeOnly(utcTime);
        const timeAgo = getTimeAgo(utcTime);
        const fullTime = formatToIST(utcTime);
        element.innerHTML = `
            <span title="${fullTime} IST">${timeOnly}</span>
            <br>${timeAgo}
        `;
    });
    
    // Convert durations
    document.querySelectorAll('[data-duration]').forEach(element => {
        const loginTime = element.getAttribute('data-login');
        const lastActivity = element.getAttribute('data-last');
        element.textContent = calculateDuration(loginTime, lastActivity);
    });
    
    // Convert UTC times in alert panels
    document.querySelectorAll('[data-utc-time]').forEach(element => {
        const utcTime = element.getAttribute('data-utc-time');
        element.textContent = formatToIST(utcTime);
    });
}

function updateTimeAgoBadges() {
    document.querySelectorAll('[data-last-activity]').forEach(element => {
        const utcTime = element.getAttribute('data-last-activity');
        const timeOnly = formatTimeOnly(utcTime);
        const timeAgo = getTimeAgo(utcTime);
        const fullTime = formatToIST(utcTime);
        element.innerHTML = `
            <span title="${fullTime} IST">${timeOnly}</span>
            <br>${timeAgo}
        `;
    });
}

function loadRecentUsers() {
    const loadBtn = document.querySelector('button[onclick="loadRecentUsers()"]');
    loadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
    loadBtn.disabled = true;
    
    fetch('/admin/recent-users-with-sessions')
        .then(response => response.json())
        .then(data => {
            if (data.users) {
                const content = `
                    <div class="row">
                        ${data.users.map(user => {
                            const lastActivity = user.last_activity ? formatToIST(user.last_activity) + ' IST' : 'Never';
                            return `
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="card user-card ${user.has_active_sessions ? 'user-status-active' : 'user-status-inactive'}" onclick="viewUserSessions(${user.id})">
                                    <div class="card-body p-3">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="mb-1">${user.username}</h6>
                                                <small class="text-muted">${user.email}</small>
                                                ${user.is_admin ? '<br><span class="badge bg-danger mt-1">Admin</span>' : ''}
                                            </div>
                                            <div class="text-end">
                                                <span class="badge ${user.has_active_sessions ? 'bg-success' : 'bg-secondary'}">
                                                    ${user.has_active_sessions ? 'Online' : 'Offline'}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="mt-2">
                                            <small class="text-info">
                                                <i class="fas fa-clock me-1"></i>
                                                Total sessions: ${user.total_sessions}
                                            </small>
                                            <br>
                                            <small class="text-muted">
                                                Last seen: ${lastActivity}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                    ${data.users.length === 0 ? '<p class="text-center text-muted">No users found with recent sessions.</p>' : ''}
                `;
                
                document.getElementById('recent-users-section').innerHTML = content;
            } else {
                showAlert('danger', 'Failed to load recent users');
            }
        })
        .catch(error => {
            showAlert('danger', 'An error occurred while loading recent users');
            console.error(error);
        })
        .finally(() => {
            loadBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
            loadBtn.disabled = false;
        });
}

function terminateSession(sessionId) {
    if (confirm('Are you sure you want to terminate this session? The user will be logged out immediately.')) {
        fetch(`/admin/session/${sessionId}/terminate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', data.message);
                document.getElementById(`session-${sessionId}`).remove();
                updateSessionCounts();
            } else {
                showAlert('danger', data.error);
            }
        })
        .catch(error => {
            showAlert('danger', 'An error occurred');
            console.error(error);
        });
    }
}

function viewSessionDetails(sessionId) {
    // Find session data from the table
    const row = document.getElementById(`session-${sessionId}`);
    if (!row) return;
    
    const cells = row.cells;
    const content = `
        <div class="row">
            <div class="col-12">
                <h6>Session Information</h6>
                <table class="table table-sm">
                    <tr><td><strong>Session ID:</strong></td><td class="font-monospace">${sessionId}</td></tr>
                    <tr><td><strong>User:</strong></td><td>${cells[0].textContent.trim()}</td></tr>
                    <tr><td><strong>IP Address:</strong></td><td class="font-monospace">${cells[1].textContent.trim()}</td></tr>
                    <tr><td><strong>Location:</strong></td><td>${cells[2].textContent.trim()}</td></tr>
                    <tr><td><strong>Device:</strong></td><td>${cells[3].textContent.trim()}</td></tr>
                    <tr><td><strong>Browser:</strong></td><td>${cells[4].textContent.trim()}</td></tr>
                    <tr><td><strong>Login Time:</strong></td><td>${cells[5].textContent.trim()}</td></tr>
                    <tr><td><strong>Last Activity:</strong></td><td>${cells[6].textContent.trim()}</td></tr>
                    <tr><td><strong>Session Duration:</strong></td><td>${cells[7].textContent.trim()}</td></tr>
                </table>
                
                <div class="mt-3">
                    <h6>Actions</h6>
                    <button class="btn btn-danger" onclick="terminateSession('${sessionId}'); bootstrap.Modal.getInstance(document.getElementById('sessionDetailsModal')).hide();">
                        <i class="fas fa-sign-out-alt me-1"></i>Terminate Session
                    </button>
                </div>
                
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        All times are displayed in Indian Standard Time (IST)
                    </small>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('sessionDetailsContent').innerHTML = content;
    new bootstrap.Modal(document.getElementById('sessionDetailsModal')).show();
}

function viewUserSessions(userId) {
    fetch(`/admin/user/${userId}/sessions`)
        .then(response => response.json())
        .then(data => {
            if (data.sessions) {
                const content = `
                    <div class="row mb-3">
                        <div class="col-12">
                            <h6>User: ${data.user.username} (${data.user.email})</h6>
                            ${data.has_multiple_active ? '<span class="badge bg-warning">Has Multiple Active Sessions</span>' : ''}
                        </div>
                    </div>
                    
                    <div class="table-responsive" style="max-height: 500px;">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>IP Address</th>
                                    <th>Device & Browser</th>
                                    <th>Location</th>
                                    <th>Login Time</th>
                                    <th>Last Activity</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.sessions.map(session => {
                                    const loginTime = session.login_time ? formatToIST(session.login_time) + ' IST' : 'N/A';
                                    const lastActivity = session.last_activity ? formatToIST(session.last_activity) + ' IST' : 'N/A';
                                    return `
                                    <tr class="${session.is_active ? 'table-success' : 'table-secondary'}">
                                        <td class="font-monospace">${session.ip_address}</td>
                                        <td>
                                            <div>${session.device}</div>
                                            <small class="text-muted">${session.browser} on ${session.operating_system}</small>
                                        </td>
                                        <td>${session.location || 'Unknown'}</td>
                                        <td class="small">${loginTime}</td>
                                        <td class="small">${lastActivity}</td>
                                        <td>
                                            <span class="badge ${session.is_active ? 'bg-success' : 'bg-secondary'}">
                                                ${session.is_active ? 'Active' : 'Inactive'}
                                            </span>
                                        </td>
                                        <td>
                                            ${session.is_active ? 
                                                `<button class="btn btn-sm btn-outline-danger" onclick="terminateSession('${session.id}')">
                                                    <i class="fas fa-times"></i>
                                                </button>` : 
                                                '<span class="text-muted">-</span>'
                                            }
                                        </td>
                                    </tr>
                                `}).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            All times are displayed in Indian Standard Time (IST)
                        </small>
                    </div>
                `;
                
                document.getElementById('userSessionsContent').innerHTML = content;
                new bootstrap.Modal(document.getElementById('userSessionsModal')).show();
            }
        })
        .catch(error => {
            showAlert('danger', 'Failed to load user sessions');
            console.error(error);
        });
}

function cleanupOldSessions() {
    if (confirm('This will remove all inactive sessions older than 30 days. Continue?')) {
        fetch('/admin/cleanup_sessions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', `Cleaned up ${data.removed} old sessions`);
            } else {
                showAlert('danger', data.error);
            }
        })
        .catch(error => {
            showAlert('danger', 'An error occurred during cleanup');
            console.error(error);
        });
    }
}

function refreshSessions() {
    showAlert('info', 'Refreshing sessions...');
    setTimeout(() => {
        location.reload();
    }, 1000);
}

function updateSessionCounts() {
    // Update the statistics cards
    const activeSessionsCount = document.querySelectorAll('#sessions-table tbody tr').length;
    // Update counts in the UI if needed
}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.container');
    container.insertBefore(alertDiv, container.firstChild);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Auto-refresh every 2 minutes
setInterval(() => {
    location.reload();
}, 120000);

// Initialize tooltips
document.addEventListener('DOMContentLoaded', function() {
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
    const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>

{% endblock %}